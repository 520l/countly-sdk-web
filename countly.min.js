(function(a){function l(b){!a.app_key||!a.device_id?g("app_key or device_id is missing"):(b.app_key=a.app_key,b.device_id=a.device_id,a.country_code&&(b.country_code=a.country_code),a.city&&(b.city=a.city),a.ip_address&&(b.ip_address=a.ip_address),b.timestamp=p(),i.push(b),j("cly_queue",i,!0))}function q(){if(a.q&&0<a.q.length){for(var b,h=0;h<a.q.length;h++)if(b=a.q[h],b.constructor===Array&&0<b.length&&(g("Processing queued call",b),a[b[0]]))a[b[0]](b[1]);a.q=[]}m&&r&&(b=p(),30<b-n&&(a.session_duration(b-
n),n=b));0<k.length&&(10>=k.length?(l({events:JSON.stringify(k)}),k=[]):(k.splice(0,10),l({events:JSON.stringify(k)})));if(0<i.length){var c=i.shift();g("Processing request",c);var d=function(b,a){g("Request Finished",a,!1);b&&(i.unshift(a),j("cly_queue",i,!0))};try{g("Sending XML HTTP request");var f=window.XMLHttpRequest?new window.XMLHttpRequest:window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):null;f.open("GET",a.url+u+"?"+v(c),!0);f.onreadystatechange=function(){4===this.readyState&&
200<=this.status&&300>this.status?"function"===typeof d&&d(!1,c):4===this.readyState&&(g("Failed Server XML HTTP request",this.status),"function"===typeof d&&d(!0,c))};f.send()}catch(e){g("Failed XML HTTP request",e),"function"===typeof d&&d(!0,c)}j("cly_queue",i,!0)}setTimeout(q,w)}function x(){var b={};a.app_version&&(b._app_version=a.app_version);screen.width&&(b._resolution=""+(screen.width?screen.width:"")+"x"+(screen.height?screen.height:""));var h=navigator.userAgent,c="unknown",d=[{s:"Windows 3.11",
r:/Win16/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},
{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows ME",r:/Windows ME/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OSX",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"SearchBot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}],f;for(f in d){var e=
d[f];if(e.r.test(h)){c=e.s;break}}d="unknown";/Windows/.test(c)&&(d=/Windows (.*)/.exec(c)[1],c="Windows");switch(c){case "Mac OSX":d=/Mac OS X (10[\.\_\d]+)/.exec(h)[1];break;case "Android":d=/Android ([\.\_\d]+)/.exec(h)[1];break;case "iOS":d=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer),d=d[1]+"."+d[2]+"."+(d[3]|0)}b._os=c;b._os_version=d;if(h=navigator.language||navigator.browserLanguage||navigator.systemLanguage||navigator.userLanguage)b._locale=h;g("Got metrics",b);return b}function g(){a.debug&&console&&
console.log(Array.prototype.slice.call(arguments))}function p(){return Math.floor((new Date).getTime()/1E3)}function v(b){var a=[],c;for(c in b)a.push(c+"="+encodeURIComponent(b[c]));return a.join("&")}function s(b,a){for(var c={},d,f=0;f<a.length;f++)d=a[f],b[d]&&(c[d]=b[d]);return c}var t=!1,m=!1,u="/i",w=1E3,i=[],k=[],r=!0,n;a.init=function(b){if(!t){t=!0;i=j("cly_queue")||[];b=b||{};a.debug=b.debug||a.debug||!1;a.app_key=b.app_key||a.app_key||null;var h=a,c;if(!(c=b.device_id))if(!(c=a.device_id)){if(!(c=
j("cly_id"))){var d=(new Date).getTime();c="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var a=(d+16*Math.random())%16|0;d=Math.floor(d/16);return("x"==b?a:a&3|8).toString(16)})}j("cly_id",c)}h.device_id=c;h=a;c=b.url||a.url||"https://cloud.count.ly";c="/"==c.substr(c.length-1)?c.substr(0,c.length-1):c;h.url=c;a.app_version=b.app_version||a.app_version||null;a.country_code=b.country_code||a.country_code||null;a.city=b.city||a.city||null;a.ip_address=b.ip_address||a.ip_address||
null;a.q=a.q||[];a.q.constructor!==Array&&(a.q=[]);q();g("Countly initialized")}};a.begin_session=function(b){m||(g("Session started"),n=p(),m=!0,r=b?!1:!0,b={begin_session:1},j("cly_first_"+a.device_id)||(j("cly_first_"+a.device_id,!0),b.metrics=JSON.stringify(x())),l(b))};a.session_duration=function(b){m&&(g("Session extended",b),l({session_duration:b}))};a.end_session=function(){m&&(g("Ending session"),m=!1,l({end_session:1,session_duration:p()-n}))};a.add_event=function(b){b.key?(b.count||(b.count=
1),k.push(s(b,["key","count","sum","segmentation"])),g("Adding event: ",b)):g("Event must have key property")};a.user_details=function(b){g("Adding userdetails: ",b);l({user_details:JSON.stringify(s(b,"name username email organization phone picture gender byear custom".split(" ")))})};var j=function(b,a,c){function d(a,b,c){var d=new Date;d.setTime(d.getTime()+864E5*c);c="; expires="+d.toGMTString();document.cookie=a+"="+b+c+"; path=/"}var f=!1,e;localStorage&&(f=!0);"undefined"!==typeof a&&null!==
a&&("object"===typeof a&&(a=JSON.stringify(a)),f?localStorage.setItem(b,a):c||d(b,a,30));if("undefined"===typeof a){if(f)e=localStorage.getItem(b);else if(!c)a:{b+="=";a=document.cookie.split(";");c=0;for(f=a.length;c<f;c++){for(e=a[c];" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b)){e=e.substring(b.length,e.length);break a}}e=null}try{e=JSON.parse(e)}catch(g){}return e}null===a&&(f?localStorage.removeItem(b):c||d(b,"",-1))}})(window.Countly=window.Countly||{});
