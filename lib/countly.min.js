(function(b){function I(){if(x){w||y();var a={name:x,segment:w};b.add_event({key:"[CLY]_view",dur:i()-z,segmentation:a});x=null}}function n(a){if(!b.ignore_bots||!J)if(!b.app_key||!b.device_id)j("app_key or device_id is missing");else{a.app_key=b.app_key;a.device_id=b.device_id;b.country_code&&(a.country_code=b.country_code);b.city&&(a.city=b.city);null!==b.ip_address&&(a.ip_address=b.ip_address);a.timestamp=i();var c=new Date;a.hour=c.getHours();a.dow=c.getDay();t.push(a);m("cly_queue",t,!0)}}function B(){if("undefined"!==
typeof b.q&&0<b.q.length){for(var a,c=0;c<b.q.length;c++)if(a=b.q[c],j("Processing queued call",a),"function"===typeof a)a();else if(a.constructor===Array&&0<a.length)if("undefined"!==typeof b[a[0]])b[a[0]].apply(null,a.slice(1));else{var e=a[0].replace("userData.","");"undefined"!==typeof b.userData[e]&&b.userData[e].apply(null,a.slice(1))}b.q=[]}v&&(K&&C)&&(a=i(),60<a-u&&(b.session_duration(a-u),u=a));0<p.length&&(10>=p.length?(n({events:JSON.stringify(p)}),p=[]):(a=p.splice(0,10),n({events:JSON.stringify(a)})),
m("cly_event",p));if(0<t.length&&D&&i()>L){D=!1;var d=t.shift();j("Processing request",d);var h=function(a,c){j("Request Finished",c,a);a&&(t.unshift(c),L=i()+E);m("cly_queue",t,!0);D=!0};try{j("Sending XML HTTP request");var g=window.XMLHttpRequest?new window.XMLHttpRequest:window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):null;g.open("GET",b.url+V+"?"+W(d),!0);g.onreadystatechange=function(){4===this.readyState&&200<=this.status&&300>this.status?"function"===typeof h&&h(!1,d):4===this.readyState&&
(j("Failed Server XML HTTP request",this.status),"function"===typeof h&&h(!0,d))};g.send()}catch(k){j("Failed XML HTTP request",k),"function"===typeof h&&h(!0,d)}}setTimeout(B,F)}function y(){var a={};a._app_version=b.app_version;screen.width&&(a._resolution=""+(screen.width?screen.width:"")+"x"+(screen.height?screen.height:""));for(var c=navigator.appVersion,e=navigator.userAgent,d=navigator.appName,h,g,k=[["Opera Mini","Opera Mini"],["Opera","Opera"],["OPR","Opera"],["MSIE","Internet Explorer"],
["IEMobile","IE Mobile"],["Edge","Edge"],["Chromium","Chromium"],["FxiOS","Firefox"],["Trident","Internet Explorer"],["FBAV/","Facebook app"],["baiduboxapp/","Baidu Box App"],["baidubrowser/","Baidu Browser"],["Dolfin","Dolfin"],["Skyfire","Skyfire"],["bolt","Bolt"],["teashark","TeaShark"],["Blazer","Blazer"],["Tizen","Tizen"],["UCWEB","UCBrowser"],["UC.","UCBrowser"],["DiigoBrowser","DiigoBrowser"],["Puffin","Puffin"],["Mercury","Mercury"],["Obigo","ObigoBrowser"],["NF-Browser","NetFront"],["amaya",
"Amaya"],["Arora","Arora"],["Avant","Avant"],["BlackBerry","BlackBerry"],["RIM","BlackBerry"],["CFNetwork","CFNetwork"],["Camino","Camino"],["Coast","Coast"],["Dalvik","Dalvik"],["Dillo","Dillo"],["DoCoMo","DoCoMo"],["ELinks","ELinks"],["Espial","Espial TV Browser"],["FlyFlow","FlyFlow"],["GSA","Google App"],["Google Desktop","Google Desktop"],["GooglePlus","Google+ App"],["IBrowse","IBrowse"],["Jasmine","Jasmine"],["Kindle","Kindle"],["Konqueror","Konqueror"],["Links","Links"],["Lotus-Notes","Lotus Notes"],
["Lynx","Lynx"],["WAP","WAP Browser"],["MiuiBrowser","Miui Browser"],["Nokia","Nokia"],["OneBrowser","OneBrowser"],["Outlook","Outlook"],["Palm","Palm"],["Pinterest","Pinterest App"],["Playstation","Playstation"],["PlayStation","Playstation"],["PLAYSTATION","Playstation"],["Polaris","Polaris"],["QQ","QQbrowser"],["Qt","Qt"],["QuickTime","QuickTime"],["SEMC-Browser","SEMC Browser"],["SamsungBrowser","Samsung Browser"],["SeaMonkey","SeaMonkey"],["Sleipnir","Sleipnir"],["SmartTV","SmartTV WebBrowser"],
["Viera","SmartViera"],["Thunderbird","Thunderbird"],["Vivaldi","Vivaldi"],["wOSBrowser","webOS"],["WebTV","WebTV"],["wp-","WordPress App"],["YaBrowser","Yandex Browser"],["iCab","iCab"],["iTunes","iTunes"],["rekonq","rekonq"],["rekonq","rekonq"],["Chrome","Chrome"],["Firefox","Firefox"],["Android","Android"],["Safari","Safari"],["iPhone","Safari"]],i=0;i<k.length;i++)if(-1!=e.indexOf(k[i][0])){d=k[i][1];break}if(!d&&(h=e.lastIndexOf(" ")+1)<(g=e.lastIndexOf("/")))d=e.substring(h,g),d.toLowerCase()==
d.toUpperCase()&&(d=navigator.appName);a._browser=d;d="unknown";h=[{s:"Windows 3.11",r:/Win16/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows 8.1",
r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows ME",r:/Windows ME/},{s:"Windows Phone",r:/Windows Phone/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OSX",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",
r:/OS\/2/},{s:"SearchBot",r:M}];for(var f in h)if(g=h[f],g.r.test(e)){d=g.s;break}f="unknown";/Windows/.test(d)&&"Windows Phone"!=d&&(f=/Windows (.*)/.exec(d)[1],d="Windows");switch(d){case "Mac OSX":f=/Mac OS X (10[\.\_\d]+)/.exec(e)[1];break;case "Windows Phone":f=(/Windows Phone ([\.\_\d]+)/.exec(e)||["","8.0"])[1];break;case "Android":f=/Android ([\.\_\d]+)/.exec(e)[1];break;case "iOS":f=/OS (\d+)_(\d+)_?(\d+)?/.exec(c),f=f[1]+"."+f[2]+"."+(f[3]|0)}w=a._os=d;a._os_version=f;c=navigator.language||
navigator.browserLanguage||navigator.systemLanguage||navigator.userLanguage;"undefined"!==typeof c&&(a._locale=c);if("undefined"!==typeof document.referrer&&document.referrer.length&&(c=N.exec(document.referrer))&&c[11]&&c[11]!=window.location.hostname)a._store=document.referrer;j("Got metrics",a);return a}function j(){b.debug&&"undefined"!==typeof console&&(arguments[1]&&"object"==typeof arguments[1]&&(arguments[1]=JSON.stringify(arguments[1])),console.log(Array.prototype.slice.call(arguments).join("\n")))}
function i(){return Math.floor((new Date).getTime()/1E3)}function G(a,c,b){var b=b||O,d="";"object"===typeof a?"undefined"!==typeof a.stack?d=a.stack:("undefined"!==typeof a.name&&(d+=a.name+":"),"undefined"!==typeof a.message&&(d+=a.message+"\n"),"undefined"!==typeof a.fileName&&(d+="in "+a.fileName+"\n"),"undefined"!==typeof a.lineNumber&&(d+="on "+a.lineNumber),"undefined"!==typeof a.columnNumber&&(d+=":"+a.columnNumber)):d=a+"";var c=c?!0:!1,a=y(),d={_os:a._os,_os_version:a._os_version,_resolution:a._resolution,
_error:d,_app_version:a._app_version,_run:i()-P,_not_os_specific:!0},h=navigator.battery||navigator.webkitBattery||navigator.mozBattery||navigator.msBattery;h&&(d._bat=Math.floor(100*h.level));"undefined"!==typeof navigator.onLine&&(d._online=navigator.onLine?!0:!1);d._background=document.hasFocus()?!1:!0;0<A.length&&(d._logs=A.join("\n"));A=[];d._nonfatal=c;d._view=(window.location.pathname||"")+(window.location.search||"")+(window.location.hash||"");d._browser=a._browser;"undefined"!==typeof b&&
(d._custom=b);try{var g=document.createElement("canvas").getContext("experimental-webgl");d._opengl=g.getParameter(g.VERSION)}catch(k){}n({crash:JSON.stringify(d)})}function W(a){var c=[],b;for(b in a)c.push(b+"="+encodeURIComponent(a[b]));return c.join("&")}function Q(a,c){for(var b={},d,h=0;h<c.length;h++)d=c[h],"undefined"!==typeof a[d]&&(b[d]=a[d]);return b}function R(a){"undefined"==typeof a.pageY&&("number"==typeof a.clientX&&document.documentElement)&&(a.pageX=a.clientX+document.body.scrollLeft+
document.documentElement.scrollLeft,a.pageY=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);return a}var S=!1,v=!1,V="/i",F=500,t=[],p=[],A=[],s={},O=null,K=!0,u,T=0,x=null,z=0,H=0,L=0,E=60,D=!0,w,N=/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,M=/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver|bingbot|Google Web Preview|Mediapartners-Google|AdsBot-Google|Baiduspider|Ezooms|YahooSeeker|AltaVista|AVSearch|Mercator|Scooter|InfoSeek|Ultraseek|Lycos|Wget|YandexBot|Yandex|YaDirectFetcher|SiteBot|Exabot|AhrefsBot|MJ12bot|TurnitinBot|magpie-crawler|Nutch Crawler|CMS Crawler|rogerbot|Domnutch|ssearch_bot|XoviBot|netseer|digincore|fr-crawler|wesee|AliasIO)/,
J=!1,C=!0,P;b.init=function(a){if(!S){P=i();S=!0;t=m("cly_queue")||[];s=m("cly_timed")||{};p=m("cly_event")||[];a=a||{};F=a.interval||b.interval||F;E=a.fail_timeout||b.fail_timeout||E;b.debug=a.debug||b.debug||!1;b.app_key=a.app_key||b.app_key||null;var c=b,e;if(!(e=a.device_id))if(!(e=b.device_id))if(!(e=m("cly_id"))){var d=(new Date).getTime();e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=(d+16*Math.random())%16|0;d=Math.floor(d/16);return("x"==a?c:c&3|8).toString(16)})}c.device_id=
e;c=b;e=a.url||b.url||"https://cloud.count.ly";e="/"==e.substr(e.length-1)?e.substr(0,e.length-1):e;c.url=e;b.app_version=a.app_version||b.app_version||"0.0";b.country_code=a.country_code||b.country_code||null;b.city=a.city||b.city||null;b.ip_address=a.ip_address||b.ip_address||null;b.ignore_bots=a.ignore_bots||b.ignore_bots||!0;b.q=b.q||[];j("Countly initialized");M.test(navigator.userAgent)&&(J=!0);b.q.constructor!==Array&&(b.q=[]);B();m("cly_id",b.device_id);if(location.search){a=location.search.substring(1).split("&");
for(c=0;c<a.length;c++)e=a[c].split("="),"cly_id"==e[0]?m("cly_cmp_id",e[1]):"cly_uid"==e[0]&&m("cly_cmp_uid",e[1])}}};b.begin_session=function(a){v||(j("Session started"),u=i(),v=!0,K=a?!1:!0,a={begin_session:1},a.metrics=JSON.stringify(y()),n(a))};b.session_duration=function(a){v&&(j("Session extended",a),n({session_duration:a}))};b.end_session=function(a){v&&(a=a||i()-u,j("Ending session"),I(),v=!1,n({end_session:1,session_duration:a}),B())};b.change_id=function(a,c){var e=b.device_id;b.device_id=
a;m("cly_id",b.device_id);j("Changing id");c&&n({old_device_id:e})};b.add_event=function(a){if(a.key){a.count||(a.count=1);var c=Q(a,["key","count","sum","dur","segmentation"]);c.timestamp=i();var b=new Date;c.hour=b.getHours();c.dow=b.getDay();p.push(c);m("cly_event",p);j("Adding event: ",a)}else j("Event must have key property")};b.start_event=function(a){s[a]?j("Timed event with key "+a+" already started"):(s[a]=i(),m("cly_timed",s))};b.end_event=function(a){"string"==typeof a&&(a={key:a});a.key?
s[a.key]?(a.dur=i()-s[a.key],b.add_event(a),delete s[a.key],m("cly_timed",s)):j("Timed event with key "+key+" was not started"):j("Event must have key property")};b.user_details=function(a){j("Adding userdetails: ",a);n({user_details:JSON.stringify(Q(a,"name username email organization phone picture gender byear custom".split(" ")))})};b.report_conversion=function(a,c){a=a||m("cly_cmp_id");c=c||m("cly_cmp_uid");a&&c?n({campaign_id:a,campaign_user:c}):a?n({campaign_id:a}):j("No campaign data found")};
var q={},r=function(a,c,b){q[a]||(q[a]={});"$push"==b||"$pull"==b||"$addToSet"==b?(q[a][b]||(q[a][b]=[]),q[a][b].push(c)):q[a][b]=c};b.userData={set:function(a,b){q[a]=b},set_once:function(a){r(a,1,"$setOnce")},increment:function(a){r(a,1,"$inc")},increment_by:function(a,b){r(a,b,"$inc")},multiply:function(a,b){r(a,b,"$mul")},max:function(a,b){r(a,b,"$max")},min:function(a,b){r(a,b,"$min")},push:function(a,b){r(a,b,"$push")},push_unique:function(a,b){r(a,b,"$addToSet")},pull:function(a,b){r(a,b,"$pull")},
save:function(){n({user_details:JSON.stringify({custom:q})});q={}}};b.track_errors=function(a){O=a;window.onerror=function(a,b,d,h,g){if("undefined"!==typeof g)G(g,!1);else{var h=h||window.event&&window.event.errorCharacter,k="";"undefined"!==typeof a&&(k+=a+"\n");"undefined"!==typeof b&&(k+="at "+b);"undefined"!==typeof d&&(k+=":"+d);"undefined"!==typeof h&&(k+=":"+h);k+="\n";try{for(var i=[],f=arguments.callee.caller;f;)i.push(f.name),f=f.caller;k+=i.join("\n")}catch(j){}G(k,!1)}}};b.log_error=
function(a,b){G(a,!0,b)};b.add_log=function(a){A.push(a)};b.stop_time=function(){C=!1;T=i()-u;H=i()-z};b.start_time=function(){C=!0;u=i()-T;z=i()-H;H=0};b.track_sessions=function(){function a(){document[c]?b.stop_time():b.start_time()}b.begin_session();b.start_time();l(window,"beforeunload",function(){b.end_session()});l(window,"unload",function(){b.end_session()});var c="hidden";c in document?document.addEventListener("visibilitychange",a):(c="mozHidden")in document?document.addEventListener("mozvisibilitychange",
a):(c="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",a):(c="msHidden")in document?document.addEventListener("msvisibilitychange",a):"onfocusin"in document?(l(window,"focusin",function(){b.start_time()}),l(window,"focusout",function(){b.stop_time()})):(l(window,"focus",function(){b.start_time()}),l(window,"blur",function(){b.stop_time()}),l(window,"pageshow",function(){b.start_time()}),l(window,"pagehide",function(){b.stop_time()}))};b.track_pageview=function(a){I();
x=a=a||window.location.pathname;z=i();w||y();a={name:a,visit:1,segment:w,domain:window.location.hostname};if("undefined"!==typeof document.referrer&&document.referrer.length){var c=N.exec(document.referrer);c&&(c[11]&&c[11]!=window.location.hostname)&&(a.start=1)}b.add_event({key:"[CLY]_view",segmentation:a})};b.track_view=function(a){b.track_pageview(a)};b.track_clicks=function(a){function c(a){if(e){e=!1;R(a);if("undefined"!==typeof a.pageX&&"undefined"!==typeof a.pageY){var c;c=document;c=Math.max(Math.max(c.body.scrollHeight,
c.documentElement.scrollHeight),Math.max(c.body.offsetHeight,c.documentElement.offsetHeight),Math.max(c.body.clientHeight,c.documentElement.clientHeight));var g;g=document;g=Math.max(Math.max(g.body.scrollWidth,g.documentElement.scrollWidth),Math.max(g.body.offsetWidth,g.documentElement.offsetWidth),Math.max(g.body.clientWidth,g.documentElement.clientWidth));b.add_event({key:"[CLY]_action",segmentation:{type:"click",x:a.pageX,y:a.pageY,width:g,height:c,domain:window.location.hostname}})}setTimeout(function(){e=
!0},1E3)}}var a=a||document,e=!0;l(a,"mousedown",c);l(a,"mouseup",c);l(a,"click",c)};b.track_links=function(a){function c(){function c(a){var d;d=a?"undefined"!==typeof a.target?a.target:a.srcElement:window.event.srcElement;R(a);b.add_event({key:"linkClick",segmentation:{href:d.href,text:d.innerText,id:d.id,x:a.pageX,y:a.pageY}});"undefined"!==typeof d.href&&("_blank"!==d.target&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&!a.shiftKey)&&0!==d.href.replace(window.location.href.split("#")[0],"").indexOf("#")&&
(b.end_session(),U(a),setTimeout(function(){window.location.href=d.href},1E3))}if("undefined"!==typeof a.getElementsByTagName)for(var d=a.getElementsByTagName("a"),h=0;h<d.length;h++)l(d[h],"click",c);else j("Can't track clicks")}a=a||document;"complete"===document.readyState?c():l(window,"load",c)};b.track_forms=function(a){function c(a){return a.name||a.id||a.type||a.nodeName}function e(a){var d=!1;l(a,"submit",function(e){if(!d){d=!0;var i={id:a.id,name:a.name,action:a.action,method:a.method},
f;if("undefined"!==typeof a.elements)for(var j=0;j<a.elements.length;j++)if(f=a.elements[j],"select"==f.nodeName.toLowerCase())if("undefined"!==typeof f.multiple){var m=[];if("undefined"!==typeof f.options)for(var l=0;l<f.options.length;l++)f.options[l].selected&&m.push(f.options[l].value);i["input:"+c(f)]=m.join()}else i["input:"+c(f)]=f.options[f.selectedIndex].value;else"input"==f.nodeName.toLowerCase()?"undefined"!==typeof f.type?"checkbox"==f.type.toLowerCase()||"radio"==f.type.toLowerCase()?
"undefined"!==typeof f.checked&&(i["input:"+c(f)]=f.value):i["input:"+c(f)]=f.value:i["input:"+c(f)]=f.value:"textarea"==f.nodeName.toLowerCase()?i["input:"+c(f)]=f.value:"undefined"!==typeof f.value&&(i["input:"+c(f)]=f.value);b.add_event({key:"formSubmit",segmentation:i});b.end_session();U(e);setTimeout(function(){a.submit()},1E3)}})}function d(){if("undefined"!==typeof a.getElementsByTagName)for(var b=a.getElementsByTagName("form"),c=0;c<b.length;c++)e(b[c]);else j("Can't track forms")}a=a||document;
"complete"===document.readyState?d():l(window,"load",d)};var l=function(a,b,e){"undefined"!==typeof a.addEventListener?a.addEventListener(b,e,!1):a.attachEvent("on"+b,e)},U=function(a){"undefined"!==typeof window.event?window.event.returnValue=!1:"undefined"!==typeof a.preventDefault?a.preventDefault():a.returnValue=!1},m=function(a,b,e){function d(a,b,c){var d=new Date;d.setTime(d.getTime()+864E5*c);c="; expires="+d.toGMTString();document.cookie=a+"="+b+c+"; path=/"}var e=e||!1,h=!1,g;if("undefined"!==
typeof localStorage){h=!0;try{localStorage.setItem("testLocal",!0)}catch(i){h=!1}}"undefined"!==typeof b&&null!==b&&("object"===typeof b&&(b=JSON.stringify(b)),h?localStorage.setItem(a,b):e||d(a,b,30));if("undefined"===typeof b){if(h)g=localStorage.getItem(a);else if(!e)a:{a+="=";b=document.cookie.split(";");e=0;for(h=b.length;e<h;e++){for(g=b[e];" "===g.charAt(0);)g=g.substring(1,g.length);if(0===g.indexOf(a)){g=g.substring(a.length,g.length);break a}}g=null}try{g=JSON.parse(g)}catch(j){}return g}null===
b&&(h?localStorage.removeItem(a):e||d(a,"",-1))}})(window.Countly=window.Countly||{});
