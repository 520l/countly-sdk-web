(function(b){function m(a){if(!b.app_key||!b.device_id)i("app_key or device_id is missing");else{a.app_key=b.app_key;a.device_id=b.device_id;b.country_code&&(a.country_code=b.country_code);b.city&&(a.city=b.city);null!==b.ip_address&&(a.ip_address=b.ip_address);a.timestamp=l();var e=new Date;a.hour=e.getHours();a.dow=e.getDay();n.push(a);p("cly_queue",n,!0)}}function u(){if("undefined"!==typeof b.q&&0<b.q.length){for(var a,e=0;e<b.q.length;e++)if(a=b.q[e],a.constructor===Array&&0<a.length&&(i("Processing queued call",
a),"undefined"!==typeof b[a[0]]))b[a[0]](a[1]);b.q=[]}r&&(z&&v)&&(a=l(),60<a-q&&(b.session_duration(a-q),q=a));0<s.length&&(10>=s.length?(m({events:JSON.stringify(s)}),s=[]):(a=s.splice(0,10),m({events:JSON.stringify(a)})));if(0<n.length&&l()>A){var c=n.shift();i("Processing request",c);var d=function(a,c){i("Request Finished",c,a);a&&(n.unshift(c),p("cly_queue",n,!0),A=l()+G)};try{i("Sending XML HTTP request");var f=window.XMLHttpRequest?new window.XMLHttpRequest:window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):
null;f.open("GET",b.url+H+"?"+I(c),!0);f.onreadystatechange=function(){4===this.readyState&&200<=this.status&&300>this.status?"function"===typeof d&&d(!1,c):4===this.readyState&&(i("Failed Server XML HTTP request",this.status),"function"===typeof d&&d(!0,c))};f.send()}catch(g){i("Failed XML HTTP request",g),"function"===typeof d&&d(!0,c)}p("cly_queue",n,!0)}setTimeout(u,J)}function B(){var a={};a._app_version=b.app_version;screen.width&&(a._resolution=""+(screen.width?screen.width:"")+"x"+(screen.height?
screen.height:""));var e=navigator.appVersion,c=navigator.userAgent,d=navigator.appName;parseFloat(navigator.appVersion);var f,g;if(-1!=c.indexOf("Opera Mini"))d="Opera Mini";else if(-1!=c.indexOf("Opera"))d="Opera";else if(-1!=c.indexOf("MSIE"))d="Internet Explorer";else if(-1!=c.indexOf("IEMobile"))d="IE Mobile";else if(-1!=c.indexOf("Chrome"))d="Chrome";else if(-1!=c.indexOf("Safari"))d="Safari";else if(-1!=c.indexOf("Firefox"))d="Firefox";else if(-1!=c.indexOf("Trident/"))d="Internet Explorer";
else if((f=c.lastIndexOf(" ")+1)<(g=c.lastIndexOf("/")))d=c.substring(f,g),d.toLowerCase()==d.toUpperCase()&&(d=navigator.appName);a._browser=d;d="unknown";f=[{s:"Windows 3.11",r:/Win16/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows Server 2003",r:/Windows NT 5.2/},
{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows ME",r:/Windows ME/},{s:"Windows Phone",r:/Windows Phone/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OSX",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},
{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"SearchBot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var j in f)if(g=f[j],g.r.test(c)){d=g.s;break}j="unknown";/Windows/.test(d)&&"Windows Phone"!=d&&(j=/Windows (.*)/.exec(d)[1],d="Windows");switch(d){case "Mac OSX":j=/Mac OS X (10[\.\_\d]+)/.exec(c)[1];break;case "Windows Phone":j=(/Windows Phone ([\.\_\d]+)/.exec(c)||["","8.0"])[1];break;case "Android":j=/Android ([\.\_\d]+)/.exec(c)[1];
break;case "iOS":j=/OS (\d+)_(\d+)_?(\d+)?/.exec(e),j=j[1]+"."+j[2]+"."+(j[3]|0)}a._os=d;a._os_version=j;e=navigator.language||navigator.browserLanguage||navigator.systemLanguage||navigator.userLanguage;"undefined"!==typeof e&&(a._locale=e);if("undefined"!==typeof document.referrer&&document.referrer.length&&(e=K.exec(document.referrer))&&e[11]&&e[11]!=window.location.hostname)a._store=document.referrer;i("Got metrics",a);return a}function i(){b.debug&&"undefined"!==typeof console&&(arguments[1]&&
"object"==typeof arguments[1]&&(arguments[1]=JSON.stringify(arguments[1])),console.log(Array.prototype.slice.call(arguments).join("\n")))}function l(){return Math.floor((new Date).getTime()/1E3)}function w(a,b){var c="";"object"===typeof a?"undefined"!==typeof a.stack?c=a.stack:("undefined"!==typeof a.name&&(c+=a.name+":"),"undefined"!==typeof a.message&&(c+=a.message+"\n"),"undefined"!==typeof a.fileName&&(c+="in "+a.fileName+"\n"),"undefined"!==typeof a.lineNumber&&(c+="on "+a.lineNumber),"undefined"!==
typeof a.columnNumber&&(c+=":"+a.columnNumber)):c=a+"";var b=b?!0:!1,d=B(),c={_os:d._os,_os_version:d._os_version,_resolution:d._resolution,_error:c,_app_version:d._app_version,_manufacture:d._browser,_run:l()-C};if(d=navigator.battery||navigator.webkitBattery||navigator.mozBattery||navigator.msBattery)c._bat=Math.floor(100*d.level);"undefined"!==typeof navigator.onLine&&(c._online=navigator.onLine?!0:!1);c._background=document.hasFocus()?!1:!0;0<t.length&&(c._logs=t.join("\n"));t=[];c._nonfatal=
b;"undefined"!==typeof x&&(c._custom=x);try{gl=document.createElement("canvas").getContext("experimental-webgl"),c._opengl=gl.getParameter(gl.VERSION)}catch(f){}m({crash:JSON.stringify(c)})}function I(a){var b=[],c;for(c in a)b.push(c+"="+encodeURIComponent(a[c]));return b.join("&")}function D(a,b){for(var c={},d,f=0;f<b.length;f++)d=b[f],"undefined"!==typeof a[d]&&(c[d]=a[d]);return c}var E=!1,r=!1,H="/i",J=500,n=[],s=[],t=[],x=null,z=!0,q,y=0,A=0,G=60,K=/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,
v=!0,C;b.init=function(a){if(!E){C=l();E=!0;n=p("cly_queue")||[];a=a||{};b.debug=a.debug||b.debug||!1;b.app_key=a.app_key||b.app_key||null;var e=b,c;if(!(c=a.device_id))if(!(c=b.device_id)){if(!(c=p("cly_id"))){var d=(new Date).getTime();c="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=(d+16*Math.random())%16|0;d=Math.floor(d/16);return("x"==a?c:c&3|8).toString(16)})}p("cly_id",c)}e.device_id=c;e=b;c=a.url||b.url||"https://cloud.count.ly";c="/"==c.substr(c.length-1)?c.substr(0,
c.length-1):c;e.url=c;b.app_version=a.app_version||b.app_version||"0.0";b.country_code=a.country_code||b.country_code||null;b.city=a.city||b.city||null;b.ip_address=a.ip_address||b.ip_address||null;b.q=b.q||[];i("Countly initialized");b.q.constructor!==Array&&(b.q=[]);u();p("cly_id",b.device_id)}};b.begin_session=function(a){r||(i("Session started"),q=l(),r=!0,z=a?!1:!0,a={begin_session:1},a.metrics=JSON.stringify(B()),m(a))};b.session_duration=function(a){r&&(i("Session extended",a),m({session_duration:a}))};
b.end_session=function(){r&&(i("Ending session"),r=!1,m({end_session:1,session_duration:l()-q}),u())};b.change_id=function(a){var e=b.device_id;b.device_id=a;p("cly_id",b.device_id);i("Changing id");m({old_device_id:e})};b.add_event=function(a){if(a.key){a.count||(a.count=1);var b=D(a,["key","count","sum","segmentation"]);b.timestamp=l();var c=new Date;b.hour=c.getHours();b.dow=c.getDay();s.push(b);i("Adding event: ",a)}else i("Event must have key property")};b.user_details=function(a){i("Adding userdetails: ",
a);m({user_details:JSON.stringify(D(a,"name username email organization phone picture gender byear custom".split(" ")))})};b.track_errors=function(a){x=a;window.onerror=function(a,c,b,f,g){if("undefined"!==typeof g)w(g,!1);else{var f=f||window.event&&window.event.errorCharacter,j="";"undefined"!==typeof a&&(j+=a+"\n");"undefined"!==typeof c&&(j+="at "+c);"undefined"!==typeof b&&(j+=":"+b);"undefined"!==typeof f&&(j+=":"+f);j+="\n";try{for(var i=[],h=arguments.callee.caller;h;)i.push(h.name),h=h.caller;
j+=i.join("\n")}catch(k){}w(j,!1)}}};b.log_error=function(a){w(a,!0)};b.add_log=function(a){t.push(a)};b.stop_time=function(){v=!1;y=l()-q};b.start_time=function(){v=!0;q=l()-y;y=0};b.track_sessions=function(){function a(){document[e]?b.stop_time():b.start_time()}b.begin_session();b.start_time();k(window,"beforeunload",function(){b.stop_time()});k(window,"unload",function(){b.stop_time()});var e="hidden";e in document?document.addEventListener("visibilitychange",a):(e="mozHidden")in document?document.addEventListener("mozvisibilitychange",
a):(e="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",a):(e="msHidden")in document?document.addEventListener("msvisibilitychange",a):"onfocusin"in document?(k(window,"focusin",function(){b.start_time()}),k(window,"focusout",function(){b.stop_time()})):(k(window,"focus",function(){b.start_time()}),k(window,"blur",function(){b.stop_time()}),k(window,"pageshow",function(){b.start_time()}),k(window,"pagehide",function(){b.stop_time()}))};b.track_pageview=function(a){a=a||
window.location.pathname;b.add_event({key:"[CLY]_view",segmentation:{name:a}})};b.track_clicks=function(){function a(a){if(e){e=!1;var d;d=a?"undefined"!==typeof a.target?a.target:a.srcElement:window.event.srcElement;"undefined"==typeof a.pageY&&("number"==typeof a.clientX&&document.documentElement)&&(a.pageX=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,a.pageY=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);if("undefined"!==typeof a.pageX&&"undefined"!==
typeof a.pageY){var f;f=document;f=Math.max(Math.max(f.body.scrollHeight,f.documentElement.scrollHeight),Math.max(f.body.offsetHeight,f.documentElement.offsetHeight),Math.max(f.body.clientHeight,f.documentElement.clientHeight));var g;g=document;g=Math.max(Math.max(g.body.scrollWidth,g.documentElement.scrollWidth),Math.max(g.body.offsetWidth,g.documentElement.offsetWidth),Math.max(g.body.clientWidth,g.documentElement.clientWidth));b.add_event({key:"[CLY]_action",segmentation:{type:"click",x:a.pageX,
y:a.pageY,width:g,height:f,rx:parseInt(a.pageX)/g,ry:parseInt(a.pageY)/f}})}"undefined"!==typeof d.href&&("_blank"!==d.target&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&!a.shiftKey)&&0!==d.href.replace(window.location.href.split("#")[0],"").indexOf("#")&&(b.end_session(),F(a),setTimeout(function(){window.location.href=d.href},1E3));setTimeout(function(){e=!0},1E3)}}var e=!0;k(document.body,"mousedown",a);k(document.body,"mouseup",a);k(document.body,"click",a)};b.track_forms=function(a){function e(a){return a.name||
a.id||a.type||a.nodeName}function c(a){var c=!1;k(a,"submit",function(d){if(!c){c=!0;var i={id:a.id,name:a.name,action:a.action,method:a.method},h;if("undefined"!==typeof a.elements)for(var k=0;k<a.elements.length;k++)if(h=a.elements[k],"select"==h.nodeName.toLowerCase())if("undefined"!==typeof h.multiple){var l=[];if("undefined"!==typeof h.options)for(var m=0;m<h.options.length;m++)h.options[m].selected&&l.push(h.options[m].value);i["input:"+e(h)]=l.join()}else i["input:"+e(h)]=h.options[h.selectedIndex].value;
else"input"==h.nodeName.toLowerCase()?"undefined"!==typeof h.type?"checkbox"==h.type.toLowerCase()||"radio"==h.type.toLowerCase()?"undefined"!==typeof h.checked&&(i["input:"+e(h)]=h.value):i["input:"+e(h)]=h.value:i["input:"+e(h)]=h.value:"textarea"==h.nodeName.toLowerCase()?i["input:"+e(h)]=h.value:"undefined"!==typeof h.value&&(i["input:"+e(h)]=h.value);b.add_event({key:"formSubmit",segmentation:i});b.end_session();F(d);setTimeout(function(){a.submit()},1E3)}})}function d(){if("undefined"!==typeof a.getElementsByTagName)for(var b=
a.getElementsByTagName("form"),d=0;d<b.length;d++)c(b[d]);else i("Can't track forms")}a=a||document;"complete"===document.readyState?d():k(window,"load",d)};var k=function(a,b,c){"undefined"!==typeof a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},F=function(a){"undefined"!==typeof window.event?window.event.returnValue=!1:"undefined"!==typeof a.preventDefault?a.preventDefault():a.returnValue=!1},p=function(a,b,c){function d(a,b,c){var d=new Date;d.setTime(d.getTime()+864E5*
c);c="; expires="+d.toGMTString();document.cookie=a+"="+b+c+"; path=/"}var c=c||!1,f=!1,g;"undefined"!==typeof localStorage&&(f=!0);"undefined"!==typeof b&&null!==b&&("object"===typeof b&&(b=JSON.stringify(b)),f?localStorage.setItem(a,b):c||d(a,b,30));if("undefined"===typeof b){if(f)g=localStorage.getItem(a);else if(!c)a:{a+="=";b=document.cookie.split(";");c=0;for(f=b.length;c<f;c++){for(g=b[c];" "===g.charAt(0);)g=g.substring(1,g.length);if(0===g.indexOf(a)){g=g.substring(a.length,g.length);break a}}g=
null}try{g=JSON.parse(g)}catch(i){}return g}null===b&&(f?localStorage.removeItem(a):c||d(a,"",-1))}})(window.Countly=window.Countly||{});
