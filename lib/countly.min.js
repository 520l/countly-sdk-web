(function(b){function R(){if(C){var a={name:C,segment:ea};b.add_event({key:"[CLY]_view",dur:p()-D,segmentation:a});C=null}}function s(a){if(!E)if(!b.app_key||!b.device_id)k("app_key or device_id is missing");else{a.app_key=b.app_key;a.device_id=b.device_id;a.sdk_name=fa;b.country_code&&(a.country_code=b.country_code);b.city&&(a.city=b.city);null!==b.ip_address&&(a.ip_address=b.ip_address);a.timestamp=S();var c=new Date;a.hour=c.getHours();a.dow=c.getDay();t.length>J&&t.shift();t.push(a);q("cly_queue",
t,!0)}}function K(){if("undefined"!==typeof b.q&&0<b.q.length){for(var a,c=0;c<b.q.length;c++)if(a=b.q[c],k("Processing queued call",a),"function"===typeof a)a();else if(a.constructor===Array&&0<a.length)if("undefined"!==typeof b[a[0]])b[a[0]].apply(null,a.slice(1));else{var d=a[0].replace("userData.","");"undefined"!==typeof b.userData[d]&&b.userData[d].apply(null,a.slice(1))}b.q=[]}y&&(T&&B)&&(a=p(),a-x>L&&(b.session_duration(a-x),x=a));0<u.length&&(u.length<=F?(s({events:JSON.stringify(u)}),u=
[]):(a=u.splice(0,F),s({events:JSON.stringify(a)})),q("cly_event",u));if(0<t.length&&M&&p()>U){M=!1;var f=t.shift();k("Processing request",f);var l=function(a,c){k("Request Finished",c,a);a&&(t.unshift(c),U=p()+N);q("cly_queue",t,!0);M=!0};try{k("Sending XML HTTP request");var i=window.XMLHttpRequest?new window.XMLHttpRequest:window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):null,j;a=[];for(var g in f)a.push(g+"="+encodeURIComponent(f[g]));j=a.join("&");g="GET";2E3<=j.length?g="POST":b.force_post&&
(g="POST");"GET"===g?i.open("GET",b.url+V+"?"+j,!0):(i.open("POST",b.url+V,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"));i.onreadystatechange=function(){4===this.readyState&&200<=this.status&&300>this.status?"function"===typeof l&&l(!1,f):4===this.readyState&&(k("Failed Server XML HTTP request",this.status),"function"===typeof l&&l(!0,f))};"GET"==g?i.send():i.send(j)}catch(e){k("Failed XML HTTP request",e),"function"===typeof l&&l(!0,f)}}setTimeout(K,O)}function W(){var a=
{};a._app_version=b.app_version;a._ua=navigator.userAgent;screen.width&&(a._resolution=""+(screen.width?screen.width:"")+"x"+(screen.height?screen.height:""));var c=navigator.language||navigator.browserLanguage||navigator.systemLanguage||navigator.userLanguage;"undefined"!==typeof c&&(a._locale=c);if("undefined"!==typeof document.referrer&&document.referrer.length&&(c=X.exec(document.referrer))&&c[11]&&c[11]!=window.location.hostname){c=!1;if(z&&z.length)for(var d=0;d<z.length;d++)try{if(RegExp(z[d]).test(document.referrer)){k("Ignored:",
document.referrer);c=!0;break}}catch(f){}c||(a._store=document.referrer)}k("Got metrics",a);return a}function k(){b.debug&&"undefined"!==typeof console&&(arguments[1]&&"object"==typeof arguments[1]&&(arguments[1]=JSON.stringify(arguments[1])),console.log(Array.prototype.slice.call(arguments).join("\n")))}function p(){return Math.floor((new Date).getTime()/1E3)}function S(){var a=(new Date).getTime();Y==a&&a++;return Y=a}function P(a,c,b){var b=b||Z,f="";"object"===typeof a?"undefined"!==typeof a.stack?
f=a.stack:("undefined"!==typeof a.name&&(f+=a.name+":"),"undefined"!==typeof a.message&&(f+=a.message+"\n"),"undefined"!==typeof a.fileName&&(f+="in "+a.fileName+"\n"),"undefined"!==typeof a.lineNumber&&(f+="on "+a.lineNumber),"undefined"!==typeof a.columnNumber&&(f+=":"+a.columnNumber)):f=a+"";c=c?!0:!1;a=W();f={_resolution:a._resolution,_error:f,_app_version:a._app_version,_run:p()-$,_not_os_specific:!0};if(a=navigator.battery||navigator.webkitBattery||navigator.mozBattery||navigator.msBattery)f._bat=
Math.floor(100*a.level);"undefined"!==typeof navigator.onLine&&(f._online=navigator.onLine?!0:!1);f._background=document.hasFocus()?!1:!0;0<G.length&&(f._logs=G.join("\n"));G=[];f._nonfatal=c;f._view=(window.location.pathname||"")+(window.location.search||"")+(window.location.hash||"");"undefined"!==typeof b&&(f._custom=b);try{var l=document.createElement("canvas").getContext("experimental-webgl");f._opengl=l.getParameter(l.VERSION)}catch(i){}s({crash:JSON.stringify(f)})}function aa(a,c){for(var b=
{},f,l=0;l<c.length;l++)f=c[l],"undefined"!==typeof a[f]&&(b[f]=a[f]);return b}function ba(a){"undefined"==typeof a.pageY&&("number"==typeof a.clientX&&document.documentElement)&&(a.pageX=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,a.pageY=a.clientY+document.body.scrollTop+document.documentElement.scrollTop);return a}var fa="javascript_native_web",ca=!1,y=!1,V="/i",O=500,J=1E3,t=[],u=[],G=[],A={},z=[],Z=null,T=!0,x,da=0,C=null,D=0,Q=0,U=0,N=60,H=20,I=0,L=60,F=10,Y=0,M=!0,
ea,X=/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,ga=/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver|bingbot|Google Web Preview|Mediapartners-Google|AdsBot-Google|Baiduspider|Ezooms|YahooSeeker|AltaVista|AVSearch|Mercator|Scooter|InfoSeek|Ultraseek|Lycos|Wget|YandexBot|Yandex|YaDirectFetcher|SiteBot|Exabot|AhrefsBot|MJ12bot|TurnitinBot|magpie-crawler|Nutch Crawler|CMS Crawler|rogerbot|Domnutch|ssearch_bot|XoviBot|netseer|digincore|fr-crawler|wesee|AliasIO)/,
E=!1,B=!0,$;b.init=function(a){if(!ca){$=p();ca=!0;t=q("cly_queue")||[];A={};u=q("cly_event")||[];a=a||{};O=a.interval||b.interval||O;J=a.queue_size||b.queue_size||J;N=a.fail_timeout||b.fail_timeout||N;H=a.inactivity_time||b.inactivity_time||H;L=a.session_update||b.session_update||L;F=a.max_events||b.max_events||F;b.ignore_prefetch=a.ignore_prefetch||b.ignore_prefetch||!0;b.debug=a.debug||b.debug||!1;b.app_key=a.app_key||b.app_key||null;var c=b,d;if(!(d=a.device_id))if(!(d=b.device_id))if(!(d=q("cly_id"))){var f=
(new Date).getTime();d="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c=(f+16*Math.random())%16|0;f=Math.floor(f/16);return("x"==a?c:c&3|8).toString(16)})}c.device_id=d;c=b;d=a.url||b.url||"https://cloud.count.ly";d="/"==d.substr(d.length-1)?d.substr(0,d.length-1):d;c.url=d;b.app_version=a.app_version||b.app_version||"0.0";b.country_code=a.country_code||b.country_code||null;b.city=a.city||b.city||null;b.ip_address=a.ip_address||b.ip_address||null;b.ignore_bots=a.ignore_bots||
b.ignore_bots||!0;b.force_post=a.force_post||b.force_post||!1;b.q=b.q||[];a.ignore_referrers&&a.ignore_referrers.constructor===Array?z=a.ignore_referrers:b.ignore_referrers&&b.ignore_referrers.constructor===Array&&(z=b.ignore_referrers);b.ignore_prefetch&&("undefined"!==typeof document.visibilityState&&"prerender"===document.visibilityState)&&(E=!0);b.ignore_bots&&ga.test(navigator.userAgent)&&(E=!0);if(!E&&(k("Countly initialized"),b.q.constructor!==Array&&(b.q=[]),K(),q("cly_id",b.device_id),location.search)){a=
location.search.substring(1).split("&");for(c=0;c<a.length;c++)d=a[c].split("="),"cly_id"==d[0]?q("cly_cmp_id",d[1]):"cly_uid"==d[0]&&q("cly_cmp_uid",d[1])}}};b.begin_session=function(a){y||(k("Session started"),x=p(),y=!0,T=a?!1:!0,a={begin_session:1},a.metrics=JSON.stringify(W()),s(a))};b.session_duration=function(a){y&&(k("Session extended",a),s({session_duration:a}))};b.end_session=function(a){y&&(a=a||p()-x,k("Ending session"),R(),y=!1,s({end_session:1,session_duration:a}),K())};b.change_id=
function(a,c){if(b.device_id!=a){var d=b.device_id;b.device_id=a;q("cly_id",b.device_id);k("Changing id");c&&s({old_device_id:d})}};b.add_event=function(a){if(a.key){a.count||(a.count=1);var c=aa(a,["key","count","sum","dur","segmentation"]);c.timestamp=S();var b=new Date;c.hour=b.getHours();c.dow=b.getDay();u.push(c);q("cly_event",u);k("Adding event: ",a)}else k("Event must have key property")};b.start_event=function(a){A[a]?k("Timed event with key "+a+" already started"):A[a]=p()};b.end_event=function(a){"string"==
typeof a&&(a={key:a});a.key?A[a.key]?(a.dur=p()-A[a.key],b.add_event(a),delete A[a.key]):k("Timed event with key "+a.key+" was not started"):k("Event must have key property")};b.user_details=function(a){k("Adding userdetails: ",a);s({user_details:JSON.stringify(aa(a,"name username email organization phone picture gender byear custom".split(" ")))})};b.report_conversion=function(a,c){a=a||q("cly_cmp_id")||"cly_organic";c=c||q("cly_cmp_uid");a&&c?s({campaign_id:a,campaign_user:c}):a?s({campaign_id:a}):
k("No campaign data found")};var v={},w=function(a,c,b){v[a]||(v[a]={});"$push"==b||"$pull"==b||"$addToSet"==b?(v[a][b]||(v[a][b]=[]),v[a][b].push(c)):v[a][b]=c};b.userData={set:function(a,b){v[a]=b},set_once:function(a){w(a,1,"$setOnce")},increment:function(a){w(a,1,"$inc")},increment_by:function(a,b){w(a,b,"$inc")},multiply:function(a,b){w(a,b,"$mul")},max:function(a,b){w(a,b,"$max")},min:function(a,b){w(a,b,"$min")},push:function(a,b){w(a,b,"$push")},push_unique:function(a,b){w(a,b,"$addToSet")},
pull:function(a,b){w(a,b,"$pull")},save:function(){s({user_details:JSON.stringify({custom:v})});v={}}};b.track_errors=function(a){Z=a;window.onerror=function(a,b,f,l,i){if("undefined"!==typeof i)P(i,!1);else{var l=l||window.event&&window.event.errorCharacter,j="";"undefined"!==typeof a&&(j+=a+"\n");"undefined"!==typeof b&&(j+="at "+b);"undefined"!==typeof f&&(j+=":"+f);"undefined"!==typeof l&&(j+=":"+l);j+="\n";try{for(var g=[],e=arguments.callee.caller;e;)g.push(e.name),e=e.caller;j+=g.join("\n")}catch(k){}P(j,
!1)}}};b.log_error=function(a,b){P(a,!0,b)};b.add_log=function(a){G.push(a)};b.stop_time=function(){B&&(B=!1,da=p()-x,Q=p()-D)};b.start_time=function(){B||(B=!0,x=p()-da,D=p()-Q,Q=0)};b.track_sessions=function(){function a(){document[d]?b.stop_time():b.start_time()}function c(){I>=H&&b.start_time();I=0}b.begin_session();b.start_time();h(window,"beforeunload",function(){b.end_session()});h(window,"unload",function(){b.end_session()});var d="hidden";d in document?document.addEventListener("visibilitychange",
a):(d="mozHidden")in document?document.addEventListener("mozvisibilitychange",a):(d="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",a):(d="msHidden")in document?document.addEventListener("msvisibilitychange",a):"onfocusin"in document?(h(window,"focusin",function(){b.start_time()}),h(window,"focusout",function(){b.stop_time()})):(h(window,"focus",function(){b.start_time()}),h(window,"blur",function(){b.stop_time()}),h(window,"pageshow",function(){b.start_time()}),h(window,
"pagehide",function(){b.stop_time()}));h(window,"mousemove",c);h(window,"click",c);h(window,"keydown",c);h(window,"scroll",c);setInterval(function(){I++;I>=H&&b.stop_time()},6E4)};b.track_pageview=function(a,c){R();a&&a.constructor===Array&&(c=a,a=null);a=a||window.location.pathname;if(c&&c.length)for(var d=0;d<c.length;d++)try{if(RegExp(c[d]).test(a)){k("Ignored:",a);return}}catch(f){}C=a;D=p();d={name:a,visit:1,domain:window.location.hostname};if("undefined"!==typeof document.referrer&&document.referrer.length){var l=
X.exec(document.referrer);l&&(l[11]&&l[11]!=window.location.hostname)&&(d.start=1)}b.add_event({key:"[CLY]_view",segmentation:d})};b.track_view=function(a,c){b.track_pageview(a,c)};b.track_clicks=function(a){function c(a){if(d){d=!1;ba(a);if("undefined"!==typeof a.pageX&&"undefined"!==typeof a.pageY){var c;c=document;c=Math.max(Math.max(c.body.scrollHeight,c.documentElement.scrollHeight),Math.max(c.body.offsetHeight,c.documentElement.offsetHeight),Math.max(c.body.clientHeight,c.documentElement.clientHeight));
var i;i=document;i=Math.max(Math.max(i.body.scrollWidth,i.documentElement.scrollWidth),Math.max(i.body.offsetWidth,i.documentElement.offsetWidth),Math.max(i.body.clientWidth,i.documentElement.clientWidth));b.add_event({key:"[CLY]_action",segmentation:{type:"click",x:a.pageX,y:a.pageY,width:i,height:c,domain:window.location.hostname}})}setTimeout(function(){d=!0},1E3)}}var a=a||document,d=!0;h(a,"mousedown",c);h(a,"mouseup",c);h(a,"click",c)};b.track_links=function(a){function c(){function c(a){var d;
d=a?"undefined"!==typeof a.target?a.target:a.srcElement:window.event.srcElement;ba(a);b.add_event({key:"linkClick",segmentation:{href:d.href,text:d.innerText,id:d.id,x:a.pageX,y:a.pageY}});"undefined"!==typeof d.href&&"_blank"!==d.target&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&!a.shiftKey&&0!==d.href.replace(window.location.href.split("#")[0],"").indexOf("#")&&b.end_session()}if("undefined"!==typeof a.getElementsByTagName)for(var f=a.getElementsByTagName("a"),l=0;l<f.length;l++)h(f[l],"click",c);else k("Can't track clicks")}
a=a||document;"complete"===document.readyState?c():h(window,"load",c)};b.track_forms=function(a){function c(a){return a.name||a.id||a.type||a.nodeName}function d(a){var d=!1;h(a,"submit",function(){if(!d){d=!0;var f={id:a.id,name:a.name,action:a.action,method:a.method},g;if("undefined"!==typeof a.elements)for(var e=0;e<a.elements.length;e++)if((g=a.elements[e])&&"password"!=g.type)if("undefined"===typeof f["input:"+c(g)]&&(f["input:"+c(g)]=[]),"select"==g.nodeName.toLowerCase())if("undefined"!==typeof g.multiple){var k=
[];if("undefined"!==typeof g.options)for(var m=0;m<g.options.length;m++)g.options[m].selected&&k.push(g.options[m].value);f["input:"+c(g)].push(k.join(", "))}else f["input:"+c(g)].push(g.options[g.selectedIndex].value);else"input"==g.nodeName.toLowerCase()?"undefined"!==typeof g.type?"checkbox"==g.type.toLowerCase()||"radio"==g.type.toLowerCase()?g.checked&&f["input:"+c(g)].push(g.value):f["input:"+c(g)].push(g.value):f["input:"+c(g)].push(g.value):"textarea"==g.nodeName.toLowerCase()?f["input:"+
c(g)].push(g.value):"undefined"!==typeof g.value&&f["input:"+c(g)].push(g.value);for(var h in f)"undefined"!=typeof f[h].join&&(f[h]=f[h].join(", "));b.add_event({key:"formSubmit",segmentation:f});b.end_session()}})}function f(){if("undefined"!==typeof a.getElementsByTagName)for(var b=a.getElementsByTagName("form"),c=0;c<b.length;c++)d(b[c]);else k("Can't track forms")}a=a||document;"complete"===document.readyState?f():h(window,"load",f)};b.collect_from_forms=function(a,c){function d(d){var f=!1;
h(d,"submit",function(){if(!f){f=!0;var j={},g=!1,e;if("undefined"!==typeof d.elements){var h={},m=a.getElementsByTagName("LABEL"),r;for(r=0;r<m.length;r++)m[r].htmlFor&&""!==m[r].htmlFor&&(h[m[r].htmlFor]=m[r].innerText||m[r].textContent||m[r].innerHTML);for(r=0;r<d.elements.length;r++)if((e=d.elements[r])&&"password"!=e.type&&-1==e.className.indexOf("cly_user_ignore")){var n="";if("select"==e.nodeName.toLowerCase())if("undefined"!==typeof e.multiple){n=[];if("undefined"!==typeof e.options)for(m=
0;m<e.options.length;m++)e.options[m].selected&&n.push(e.options[m].value);n=n.join(", ")}else n=e.options[e.selectedIndex].value;else"input"==e.nodeName.toLowerCase()?"undefined"!==typeof e.type?"checkbox"==e.type.toLowerCase()||"radio"==e.type.toLowerCase()?e.checked&&(n=e.value):n=e.value:n=e.value:"textarea"==e.nodeName.toLowerCase()?n=e.value:"undefined"!==typeof e.value&&(n=e.value);if(e.className&&-1!=e.className.indexOf("cly_user_")){e=e.className.split(" ");for(m=0;m<e.length;m++)if(0===
e[m].indexOf("cly_user_")){j[e[m].replace("cly_user_","")]=n;g=!0;break}}else if(e.type&&"email"==e.type.toLowerCase()||e.name&&-1!=e.name.toLowerCase().indexOf("email")||e.id&&-1!=e.id.toLowerCase().indexOf("email")||e.id&&h[e.id]&&-1!=h[e.id].toLowerCase().indexOf("email")||/[^@\s]+@[^@\s]+\.[^@\s]+/.test(n))j.email||(j.email=n),g=!0;else if(e.name&&-1!=e.name.toLowerCase().indexOf("username")||e.id&&-1!=e.id.toLowerCase().indexOf("username")||e.id&&h[e.id]&&-1!=h[e.id].toLowerCase().indexOf("username"))j.username||
(j.username=n),g=!0;else if(e.name&&(-1!=e.name.toLowerCase().indexOf("tel")||-1!=e.name.toLowerCase().indexOf("phone")||-1!=e.name.toLowerCase().indexOf("number"))||e.id&&(-1!=e.id.toLowerCase().indexOf("tel")||-1!=e.id.toLowerCase().indexOf("phone")||-1!=e.id.toLowerCase().indexOf("number"))||e.id&&h[e.id]&&(-1!=h[e.id].toLowerCase().indexOf("tel")||-1!=h[e.id].toLowerCase().indexOf("phone")||-1!=h[e.id].toLowerCase().indexOf("number")))j.phone||(j.phone=n),g=!0;else if(e.name&&(-1!=e.name.toLowerCase().indexOf("org")||
-1!=e.name.toLowerCase().indexOf("company"))||e.id&&(-1!=e.id.toLowerCase().indexOf("org")||-1!=e.id.toLowerCase().indexOf("company"))||e.id&&h[e.id]&&(-1!=h[e.id].toLowerCase().indexOf("org")||-1!=h[e.id].toLowerCase().indexOf("company")))j.organization||(j.organization=n),g=!0;else if(e.name&&-1!=e.name.toLowerCase().indexOf("name")||e.id&&-1!=e.id.toLowerCase().indexOf("name")||e.id&&h[e.id]&&-1!=h[e.id].toLowerCase().indexOf("name"))j.name||(j.name=""),j.name+=n+" ",g=!0}}g&&(k("Gathered user data",
j),c?b.user_details({custom:j}):b.user_details(j));b.end_session()}})}function f(){if("undefined"!==typeof a.getElementsByTagName)for(var b=a.getElementsByTagName("form"),c=0;c<b.length;c++)d(b[c]);else k("Can't track forms")}a=a||document;"complete"===document.readyState?f():h(window,"load",f)};b.collect_from_facebook=function(a){FB&&FB.api&&FB.api("/me",function(c){var d={};c.name&&(d.name=c.name);c.email&&(d.email=c.email);"male"==c.gender?d.gender="M":"female"==c.gender&&(d.gender="F");if(c.birthday){var f=
c.birthday.split("/").pop();f&&4==f.length&&(d.byear=f)}c.work&&(c.work[0]&&c.work[0].employer&&c.work[0].employer.name)&&(d.organization=c.work[0].employer.name);if(a){d.custom={};for(var h in a){for(var f=a[h].split("."),i=c,j=0;j<f.length&&!(i=i[f[j]],"undefined"===typeof i);j++);"undefined"!==typeof i&&(d.custom[h]=i)}}b.user_details(d)})};var h=function(a,b,d){"undefined"!==typeof a.addEventListener?a.addEventListener(b,d,!1):a.attachEvent("on"+b,d)},q=function(a,b,d){function f(a,b,c){var d=
new Date;d.setTime(d.getTime()+864E5*c);c="; expires="+d.toGMTString();document.cookie=a+"="+b+c+"; path=/"}var d=d||!1,h=!1,i;if("undefined"!==typeof localStorage){h=!0;try{localStorage.setItem("testLocal",!0)}catch(j){h=!1}}"undefined"!==typeof b&&null!==b&&("object"===typeof b&&(b=JSON.stringify(b)),h?localStorage.setItem(a,b):d||f(a,b,30));if("undefined"===typeof b){if(h)i=localStorage.getItem(a);else if(!d)a:{a+="=";b=document.cookie.split(";");d=0;for(h=b.length;d<h;d++){for(i=b[d];" "===i.charAt(0);)i=
i.substring(1,i.length);if(0===i.indexOf(a)){i=i.substring(a.length,i.length);break a}}i=null}try{i=JSON.parse(i)}catch(g){}return i}null===b&&(h?localStorage.removeItem(a):d||f(a,"",-1))}})(window.Countly=window.Countly||{});
